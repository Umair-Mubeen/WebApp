<style>
    html, body {
    height: 100%;
    margin: 0;
}

.wrapper {
    min-height: 100%;
    display: flex;
    flex-direction: column;
}

.content-wrapper {
    flex: 1;
}

.main-footer {
    margin-top: auto;
}

.swal2-container .select2-container {
    display: none !important;
}




</style>

{% load static %}
{% include 'reusable.html' %}
<title>Leave Application </title>
<body class="sidebar-mini layout-fixed sidebar-collapse">
<div class="wrapper">

    <!-- Navbar Starts Here -->
    {% include 'navbar.html' %}
    <!-- /.Navbar Ends Here -->

    <!-- SideBar Start Here  -->
    {% include 'sidebar.html' %}
    <!-- SideBar Ends Here  -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Regional Tax Office - II, Dashboard</h1>
                    </div><!-- /.col -->
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/Dashboard" style="color:black"><i
                                    class="fa fa-home"></i></a>
                            </li>
                            <li class="breadcrumb-item active"><a href="/ManageLeaveApplication" style="color:black">Manage
                                Leave </a></li>

                            <li class="breadcrumb-item active">Leave Application</li>
                        </ol>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">

                <form action="LeaveApplication" id="LeaveApplication" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">

                        <div class="col-lg-5">
                            <div class="card collapsed-card">
                                <div class="card-header header-elements-inline">

                                    <h5 class="card-title">Employee Leave Application</h5>

                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i
                                                class="fas fa-minus"></i>
                                        </button>
                                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i
                                                class="fas fa-times"></i></button>
                                    </div>
                                </div>


                                <div class="card-body" style="display:block">
                                    <input type="hidden" name="hd_emp" value="" id="hd_emp">
                                    <div class="form-group">
                                        <label>Employee Name </label>

                                        <select class="js-example-basic-single form-control" name="emp_name"
                                                id="emp_name">
                                            <option value="" selected disabled>Select an employee</option>

                                            {% for item in data %}
                                            <option value="{{item.id}}">{{item.Name}} - ({{item.Designation}}) -
                                                {{item.ZONE}}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <!-- /.form-group -->


                                    <div class="form-group">
                                        <label for="leave_type">Type of Leave:</label><br>
                                        <select id="leave_type" name="leave_type" class="form-control">
                                            <option value="Casual Leave">Casual Leave (Max 20 days)</option>
                                            <option value="Earned Leave">Earned Leave (Max 48 days)</option>
                                            <option value="Ex-Pakistan Leave">Ex-Pakistan Leave</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="leave_start_date">Leave Start Date:</label><br>
                                        <input type="date" id="leave_start_date" name="leave_start_date"
                                               class="form-control">
                                    </div>

                                    <div class="form-group">
                                        <label for="leave_end_date">Leave End Date:</label>
                                        <input type="date" id="leave_end_date" name="leave_end_date"
                                               class="form-control">

                                    </div>

                                    <div class="form-group">
                                        <label for="reason">Reason for Leave:</label>
                                        <textarea id="reason" name="reason" rows="4" cols="50"
                                                  class="form-control"></textarea>

                                    </div>

                                    <div class="form-group">
                                        <label for="leave_document">Leave Application Document:</label>
                                        <input type="file" id="leave_document" name="leave_document"
                                               class="form-control"
                                               accept=".pdf,.jpg,.jpeg,.png">

                                    </div>

                                    <div class="text-right">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                        <a href="" class="btn btn-default ml-2">Cancel</a>
                                    </div>

                                </div>

                            </div>
                        </div>

                        <!-- Leave Information Table -->
                        <div class="col-lg-7">
                            <div class="card" style="display: none;" id="leaveInfo">
                                <div class="card-header header-elements-inline">

                                    <h5 class="card-title">Employee Leave Application History</h5>

                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i
                                                class="fas fa-minus"></i>
                                        </button>
                                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i
                                                class="fas fa-times"></i></button>
                                    </div>
                                </div>
                                <input type="hidden" name="empId" id="empId" value="{{empId}}">

                                <div class="card-body">
                                    <table class="table table-bordered card-body">
                                        <thead>
                                        <tr>
                                            <th>Casual Leave</th>
                                            <th>Earned Leave</th>
                                            <th>Ex-Pakistan Leave</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td id="casualLeave">0</td>
                                            <td id="earnedLeave">0</td>
                                            <td id="exPakistanLeave">0</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>
                </form>

            </div>


        </section>


    </div>
    <!-- /.content-wrapper -->


    {% include 'footer.html' %}

</div>

</body>
<script>
    $(document).ready(function() {
        // Initialize Select2 on page load
        initializeSelect2();

        // Attach the change event handler for employee selection
        $('#emp_name').change(function() {
            fetchEmployeeLeaveData($(this).val());
        });

        // If a message is passed, display it using Swal
        {% if message %}
        displayAlert("{{ title }}", "{{ message }}", "{{ icon }}");
        {% endif %}
    });

    // Function to initialize Select2
    function initializeSelect2() {
        $('.js-example-basic-single').select2();
    }

    // Function to fetch employee leave data based on selected employee
    function fetchEmployeeLeaveData(empId) {
        if (empId) {
            $.ajax({
                url: '/get_employee_leave_data/' + empId + '/',
                method: 'GET',
                success: function(data) {
                    updateLeaveInfo(data);
                },
                error: function(xhr, status, error) {
                    console.error("An error occurred while fetching leave data:", status, error);
                }
            });
        } else {
            $('#leaveInfo').hide(); // Hide the table if no employee is selected
        }
    }

    // Function to update leave information in the DOM
    function updateLeaveInfo(data) {
        // Check if data exists and update the table
        if (data) {
            $('#casualLeave').text(data.casual_leave || "N/A");
            $('#earnedLeave').text(data.earned_leave || "N/A");
            $('#exPakistanLeave').text(data.ex_pakistan_leave || "N/A");
            $('#leaveInfo').show(); // Show the table with updated data
        } else {
            console.warn("No data received.");
            $('#leaveInfo').hide(); // Hide the table if no data is received
        }
    }

    // Function to display an alert using SweetAlert
    function displayAlert(title, message, icon) {
        Swal.fire({
            title: title,
            text: message,
            icon: icon,
            didOpen: () => {
                setTimeout(() => {
                    // Re-initialize Select2 after the alert is shown
                    initializeSelect2();
                }, 1000);
            }
        });

    var hd_emp = document.getElementById('empId').value; // Get the hidden input value
    // Set the selected value and trigger select2 to update
    $('#emp_name').val(hd_emp).trigger('change');

    }

</script>
